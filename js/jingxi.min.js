var app=angular.module("jingxiApp",["ionic"]);app.factory("$debounce",["$rootScope","$browser","$q","$exceptionHandler",function(b,a,e,f){var h={},d={},g=0;function c(p,m,n){var r=e.defer(),s=r.promise,k=(angular.isDefined(n)&&!n),q,i,o,j=false;angular.forEach(d,function(u,t){if(angular.equals(d[t].fn,p)){j=true;o=t}});if(!j){o=g++;d[o]={fn:p}}else{h[d[o].timeoutId].reject("bounced");a.defer.cancel(d[o].timeoutId)}var l=function(){delete d[o];try{r.resolve(p())}catch(t){r.reject(t);f(t)}if(!k){b.$apply()}};q=a.defer(l,m);d[o].timeoutId=q;i=function(t){delete h[s.$$timeoutId]};s.$$timeoutId=q;h[q]=r;s.then(i,i);return s}c.cancel=function(i){if(i&&i.$$timeoutId in h){h[i.$$timeoutId].reject("canceled");return a.defer.cancel(i.$$timeoutId)}return false};return c}]);app.service("$customHttp",["$http","$ionicLoading",function(b,a){this.get=function(c,d){a.show({template:"loading..."});b.get(c).success(function(e){a.hide();d(e)})}}]);app.config(function(b,a){b.state("home",{url:"/myHome",templateUrl:"tpl/home.html",controller:"homeCtrl"}).state("share",{url:"/myShare",templateUrl:"tpl/community.html"}).state("credits",{url:"/myCreadis",templateUrl:"tpl/credits.html"}).state("cart",{url:"/myCart",templateUrl:"tpl/cart.html",controller:"cartCtrl"}).state("own",{url:"/myOwn",templateUrl:"tpl/own.html",controller:"ownCtrl"}).state("detail",{url:"/myDetail/:pid",templateUrl:"tpl/detail.html",controller:"detailCtrl"}).state("login",{url:"/myLogin",templateUrl:"tpl/login.html",controller:"loginCtrl"}).state("order",{url:"/myOrder/:cartDetail",templateUrl:"tpl/order.html",controller:"orderCtrl"}).state("myOrder",{url:"/myOrder",templateUrl:"tpl/myOrder.html",controller:"myOrderCtrl"}).state("settings",{url:"/mySettings",templateUrl:"tpl/settings.html",controller:"settingsCtrl"}).state("register",{url:"/myRegister",templateUrl:"tpl/register.html",controller:"registerCtrl"});a.otherwise("/myHome")});app.controller("parentCtrl",["$scope","$state",function(a,b){a.jump=function(c,d){b.go(c,d)};a.data={totalNumInCart:0};a.jumpToCart=function(c){if(sessionStorage.uname){a.LRuname=sessionStorage.uname;b.go(c)}else{b.go("own")}}}]);app.controller("homeCtrl",["$scope","$customHttp","$debounce","$ionicPopup","$ionicSideMenuDelegate",function(a,c,e,d,b){a.hasMore=true;a.inputTxt={kw:""};c.get("data/getbypage.php",function(f){a.product=f});a.loadMore=function(){c.get("data/getbypage.php?start="+a.product.length,function(f){console.log(f);if(f.length<6){a.hasMore=false}a.product=a.product.concat(f);a.$broadcast("scroll.infiniteScrollComplete")})};a.$watch("inputTxt.kw",function(){e(handleSearch,300)});handleSearch=function(){if(a.inputTxt.kw){c.get("data/getbykw.php?kw="+a.inputTxt.kw,function(f){a.product=f})}};a.addToCart=function(f){var g=sessionStorage.userId;console.log(f);if(g){c.get("data/cart_detail_add.php?userId="+g+"&productId="+f,function(h){if(h.code==1){a.data.totalNumInCart++;d.alert({template:"添加到购物车成功！"})}})}};a.left=function(){b.toggleLeft()}}]);app.controller("detailCtrl",["$scope","$stateParams","$customHttp","$ionicPopup",function(a,c,b,d){b.get("data/getbyid.php?pid="+c.pid,function(e){console.log(e[0].img1);a.product=e[0]});a.addToCart=function(e){var f=sessionStorage.userId;console.log(e);if(f){b.get("data/cart_detail_add.php?userId="+f+"&productId="+e,function(g){if(g.code==1){a.data.totalNumInCart++;d.alert({template:"添加到购物车成功！"})}})}}}]);app.controller("loginCtrl",["$scope","$customHttp","$state","$ionicPopup",function(a,c,b,d){a.login={uname:"",upwd:""};a.unameBlur=function(){c.get("data/login_uname.php?uname="+a.login.uname,function(e){a.unameMsg=e.msg})};a.upwdBlur=function(){c.get("data/login_upwd.php?uname="+a.login.uname+"&upwd="+a.login.upwd,function(e){a.upwdMsg=e.msg});console.log(a.login.upwd)};a.loginClick=function(){c.get("data/login.php?uname="+a.login.uname+"&upwd="+a.login.upwd,function(e){console.log(e);if(e.code==1){sessionStorage.userId=e.uid;sessionStorage.uname=e.uname;b.go("home")}if(sessionStorage.userId){d.alert({template:"尊敬的用户"+sessionStorage.uname+",您已登录!!!"})}})}}]);app.controller("cartCtrl",["$scope","$customHttp",function(a,d){var c=sessionStorage.userId;a.countPrice=0;a.cartContent=true;a.cartProduct="";d.get("data/cart_detail_list.php?uid="+c,function(e){a.cartProduct=e;b(e);console.log(a.cartProduct);if(a.cartProduct!=""){a.cartContent=false}});a.deleteBtn=false;a.edit="编辑";a.editClick=function(){if(a.edit=="编辑"){a.edit="完成";a.deleteBtn=true}else{if(a.edit=="完成"){a.edit="编辑";a.deleteBtn=false}}};a.userId=sessionStorage.userId;a.updateClick=function(g,h,e,f){d.get("data/update_cart_detail.php?did="+g+"&msg="+h+"&uid="+e+"&count="+f,function(i){console.log(i);a.cartProduct=i;b(i);console.log(a.cartProduct);if(a.cartProduct==""){a.cartContent=true}})};var b=function(e){a.countPrice=0;a.data.totalNumInCart=0;angular.forEach(e,function(g,f){a.countPrice+=parseFloat(g.price)*parseFloat(g.count);a.data.totalNumInCart+=parseFloat(g.count)});return a.countPrice};a.jumpToOrder=function(){var e=angular.toJson(a.cartProduct);a.jump("order",{cartDetail:e})}}]);app.controller("orderCtrl",["$scope","$customHttp","$httpParamSerializerJQLike","$stateParams","$timeout","$state",function(b,f,g,e,d,c){var a=0;angular.forEach(angular.fromJson(e.cartDetail),function(i,h){a+=parseFloat(i.price)*parseFloat(i.count)});b.order={userId:sessionStorage.userId,cartDetail:e.cartDetail,totalPrice:a};b.submitOrder=function(){var h=g(b.order);f.get("data/order_add.php?"+h,function(i){console.log(i);if(i[0].msg=="succ"){b.result="下单成功,订单编号为"+i[0].oid;b.remindText="三秒后跳转至首页...";b.data.totalNumInCart=0;d(function(){c.go("home")},3000)}else{b.result="下单失败!"}})}}]);app.controller("myOrderCtrl",["$scope","$customHttp",function(a,c){var b=sessionStorage.userId;console.log(b);c.get("data/order_getbyuserid.php?userId="+b,function(d){console.log(d);a.orderList=d.data})}]);app.controller("registerCtrl",["$scope","$customHttp","$state","$ionicPopup",function(a,c,b,d){a.register={uname:"",upwd:"",num:""};a.register=function(){c.get("data/register.php?uname="+a.register.uname,function(e){if(e.code==-1&&a.register.uname==undefined){a.unameMsg="请输入用户名"}else{a.unameMsg=e.msg}if(e.code==-1){a.ok=1}console.log(a.ok)})};a.registerClick=function(){if(!(a.register.upwd==undefined&&a.register.uname==undefined)&&a.ok==1){c.get("data/register_add_do.php?uname="+a.register.uname+"&upwd="+a.register.uname,function(e){if(e.code==1){sessionStorage.userId=e.uid;sessionStorage.uname=e.uname;b.go("home")}console.log(e)})}}}]);app.controller("settingsCtrl",["$scope","$state",function(a,b){a.out=function(){sessionStorage.userId="";sessionStorage.uname="";b.go("home")}}]);app.controller("ownCtrl",["$scope","$state",function(a,b){if(sessionStorage.uname){a.LRuname=sessionStorage.uname}else{a.LRuname="登录/注册"}a.jumpToCart=function(c){if(sessionStorage.uname){a.LRuname=sessionStorage.uname;b.go(c)}else{b.go("own")}}}]);